name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build and Test
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'
        
    - name: Setup NuGet
      uses: nuget/setup-nuget@v2
      
    - name: Restore dependencies
      run: nuget restore GitDev.sln
      
    - name: Build solution
      run: msbuild GitDev.sln /p:Configuration=Release /p:Platform="Any CPU"
      
    - name: Run tests
      run: dotnet test GitDev.sln --configuration Release --no-build --verbosity normal
      continue-on-error: true
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gitdev-build-${{ github.sha }}
        path: |
          bin/Release/
          !bin/Release/**/*.pdb
        retention-days: 30
        
  code-quality:
    name: Code Quality Analysis
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'
        
    - name: Restore dependencies
      run: nuget restore GitDev.sln
      
    - name: Run code analysis
      run: msbuild GitDev.sln /p:Configuration=Release /p:RunCodeAnalysis=true
      continue-on-error: true
      
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true
      
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true
      
  release:
    name: Create Release
    needs: [build-and-test, code-quality]
    runs-on: windows-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'
        
    - name: Setup NuGet
      uses: nuget/setup-nuget@v2
      
    - name: Restore dependencies
      run: nuget restore GitDev.sln
      
    - name: Build Release
      run: msbuild GitDev.sln /p:Configuration=Release /p:Platform="Any CPU"
      
    - name: Package application
      run: |
        mkdir release-package
        Copy-Item -Path "bin/Release/*" -Destination "release-package/" -Recurse -Exclude "*.pdb"
        Compress-Archive -Path "release-package/*" -DestinationPath "GitDev-Release.zip"
      shell: pwsh
      
    - name: Generate release notes
      id: release_notes
      run: |
        $version = Get-Date -Format "yyyy.MM.dd"
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "## GitDev Release $version" > release-notes.md
        echo "" >> release-notes.md
        echo "### Changes" >> release-notes.md
        git log -10 --pretty=format:"- %s (%an)" >> release-notes.md
      shell: pwsh
      
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.release_notes.outputs.version }}
        name: Release ${{ steps.release_notes.outputs.version }}
        body_path: release-notes.md
        files: GitDev-Release.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
